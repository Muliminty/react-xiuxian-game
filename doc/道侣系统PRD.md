# 道侣系统 - 产品需求文档 (PRD)

## 一、项目概述

### 1.1 背景

道侣系统是修仙游戏中的核心社交玩法之一，玩家可以寻找志同道合的修士结为道侣，通过双修提升修炼速度，共同踏上修仙大道。

### 1.2 目标

- 为玩家提供社交互动的玩法
- 增加游戏的策略深度和可玩性
- 提供新的修炼加速途径
- 丰富游戏剧情和故事线

---

## 二、功能可行性分析

### 2.1 技术可行性

**现有系统支持：**

| 现有模块         | 可复用内容   | 道侣系统应用                             |
| ---------------- | ------------ | ---------------------------------------- |
| types.ts         | 接口定义模式 | 定义 DaoLover、DaoLoverTemplate 等       |
| constants.ts     | 常量配置     | 定义道侣模板、好感度奖励、双修效果等     |
| PetModal.tsx     | 灵宠管理界面 | 参考设计道侣管理界面（列表、详情、操作） |
| SectModal.tsx    | 宗门管理界面 | 参考设计道侣互动界面                     |
| aiService.ts     | AI 内容生成  | 生成道侣随机性格、背景故事、对话         |
| randomService.ts | 随机数生成   | 随机生成道侣属性、奇遇事件               |
| PlayerStats      | 玩家数据结构 | 添加道侣相关字段                         |

**技术评估：**

- ✅ 数据结构扩展简单（直接在 PlayerStats 添加字段）
- ✅ UI 组件可复用现有 Modal 设计模式
- ✅ AI 服务可以生成丰富的道侣内容
- ✅ 无需后端支持，纯前端实现

### 2.2 设计可行性

**与现有系统的协调：**

- ✅ 道侣属性加成可与装备、功法、称号加成统一计算
- ✅ 道侣系统可独立开发，不影响现有功能
- ✅ 可与现有历练、奇遇系统联动（如历练遇到道侣）
- ✅ 可与宗门系统联动（同宗门寻找道侣有加成）

### 2.3 结论

**可行** - 技术上完全可行，可基于现有架构快速开发。

---

## 三、核心功能设计

### 3.1 数据结构设计

#### 3.1.1 道侣基础信息

```typescript
// 道侣状态
enum DaoLoverStatus {
  Stranger = '陌生', // 初次相遇
  Acquaintance = '相识', // 交流过
  Friend = '好友', // 好感度达到一定值
  CloseFriend = '知己', // 好感度较高
  DaoLover = '道侣', // 结为道侣
  Separated = '已分离', // 已解除道侣关系
}

// 道侣类型
enum DaoLoverType {
  NPC = 'NPC', // 生成 NPC
  Player = 'Player', // 其他玩家（如后续支持联机）
}

// 道侣
interface DaoLover {
  id: string; // 道侣唯一ID
  name: string; // 姓名
  avatar?: string; // 头像/图片
  type: DaoLoverType; // 道侣类型
  status: DaoLoverStatus; // 当前关系状态

  // 基础属性
  realm: RealmType; // 境界
  appearance?: string; // 外貌描述
  personality?: string; // 性格（AI 生成）

  // 好感度系统
  affection: number; // 好感度 (0-100)
  maxAffection: number; // 最大好感度上限

  // 道侣加成
  cultivationBonus: {
    // 双修修炼加成
    expRate: number; // 修炼速度加成 (0-1)
    hpRegen: number; // 回血速度加成
    breakthroughRate: number; // 突破成功率加成
  };

  // 互动记录
  lastInteractionTime: number; // 上次互动时间
  interactionCount: number; // 累计互动次数
  giftCount: number; // 赠送礼物次数
  dualCultivationCount: number; // 双修次数

  // 特殊能力（可选）
  specialAbilities?: string[]; // 特殊能力列表（如护道、赠药等）

  // 背景故事
  backgroundStory?: string; // 背景故事（AI 生成）
  dialogue?: string[]; // 对话记录
}

// 道侣模板（用于随机生成）
interface DaoLoverTemplate {
  id: string;
  name: string;
  nameVariants?: string[]; // 名字变体
  realmRange: [RealmType, RealmType]; // 境界范围
  personalities: string[]; // 可能的性格
  appearances: string[]; // 可能的外貌描述
  backgroundStories: string[]; // 背景故事模板
  baseCultivationBonus: {
    // 基础双修加成
    expRate: number;
    hpRegen: number;
    breakthroughRate: number;
  };
  specialAbilities?: string[]; // 特殊能力池
  rarity: ItemRarity; // 稀有度
}

// 道侣礼物
interface DaoLoverGift {
  id: string;
  name: string;
  description: string;
  category: '礼物' | '灵草' | '丹药' | '法宝' | '其他';
  affectionGain: number; // 获得的好感度
  minRealm?: RealmType; // 最低境界要求
  cost?: number; // 购买灵石（如商店有售）
}
```

#### 3.1.2 PlayerStats 扩展

```typescript
// 在 PlayerStats 中添加以下字段
interface PlayerStats {
  // ... 现有字段

  // 道侣系统
  daoLovers: DaoLover[]; // 相识的道侣列表
  activeDaoLoverId: string | null; // 当前结为道侣的ID
  daoLoverSlots: number; // 道侣槽位数（根据境界提升）

  // 道侣系统统计
  daoLoverStatistics: {
    totalDualCultivation: number; // 累计双修次数
    totalGiftGiven: number; // 累计赠送礼物次数
    totalDaoLoversMet: number; // 累计相识道侣数量
  };
}
```

### 3.2 功能模块设计

#### 3.2.1 道侣获取（相遇）

**功能描述：** 玩家可通过多种途径结识道侣

**获取方式：**

1. **历练奇遇** - 历练过程中随机遇到修士
2. **宗门推荐** - 宗门长老推荐同宗弟子
3. **洞府机缘** - 洞府修炼时有人拜访
4. **商城购买** - 使用抽奖券抽取稀有道侣（可选）
5. **任务奖励** - 完成特定任务获得道侣

**流程：**

```
历练 → AI 生成随机事件 → 遇到修士
     ↓
选择互动 → 增加好感度 → 成为相识
     ↓
继续交流/送礼 → 好感度提升 → 可结为道侣
```

#### 3.2.2 道侣管理界面

**页面结构：**

- **道侣列表页**
  - 显示所有相识的道侣
  - 显示好感度、状态、双修加成
  - 支持筛选、排序

- **道侣详情页**
  - 道侣基本信息（头像、姓名、境界）
  - 好感度进度条
  - 背景故事
  - 操作按钮：双修、送礼、对话、解除关系

**UI 设计参考：** PetModal.tsx + SectModal.tsx

#### 3.2.3 双修系统

**功能描述：** 与道侣共同修炼，获得额外加成

**触发方式：**

- 打坐时选择与道侣双修
- 需要好感度达到一定要求（如 60+）

**双修效果：**

- 修炼速度提升（基于道侣加成 + 好感度加成）
- 气血恢复速度提升
- 突破成功率小幅提升
- 消耗额外时间/灵石（平衡机制）

**计算公式：**

```
最终修炼加成 = 道侣基础加成 × (1 + 好感度加成系数)

其中：
- 好感度 0-30: 0% 额外加成
- 好感度 31-60: 10% 额外加成
- 好感度 61-80: 20% 额外加成
- 好感度 81-100: 30% 额外加成
```

#### 3.2.4 互动系统

**互动类型：**

| 互动类型     | 好感度变化 | 描述         |
| ------------ | ---------- | ------------ |
| 对话         | +1 ~ +5    | 简单交谈     |
| 赠送礼物     | +5 ~ +20   | 根据礼物价值 |
| 双修         | +2 ~ +5    | 共同修炼     |
| 完成道侣任务 | +10 ~ +30  | 特殊任务     |
| 道侣奇遇     | +5 ~ +15   | 随机事件     |

**礼物系统：**

- 普通礼物：灵草、丹药
- 稀有礼物：法宝、灵石
- 特殊礼物：天材地宝、本命法宝碎片

#### 3.2.5 道侣事件

**随机事件系统：**

1. **道侣拜访** - 道侣主动拜访玩家
2. **共同历练** - 邀请道侣一起历练
3. **赠送灵物** - 道侣赠送玩家物品
4. **道侣危机** - 道侣遇到危险，玩家选择帮助
5. **道侣进阶** - 道侣突破境界，关系更加稳固

**事件触发条件：**

- 好感度达到阈值
- 随机概率（如每日 10% 触发概率）
- 特殊时机（如道侣生日）

#### 3.2.6 关系管理

**状态转换：**

```
陌生 → 相识 → 好友 → 知己 → 道侣 → (可分离)
```

**解除关系：**

- 需要消耗灵石/物品
- 降低好感度
- 一定冷却时间后才能再次结为道侣
- 特殊情况可"和平分手"（好感度保留）

---

## 四、界面设计

### 4.1 道侣管理界面 (DaoLoverModal)

**组件结构：**

```tsx
<DaoLoverModal>
  <DaoLoverList /> // 道侣列表
  <DaoLoverDetail /> // 道侣详情
  <GiftSelector /> // 礼物选择
  <DualCultivationPanel /> // 双修面板
  <DialoguePanel /> // 对话面板
</DaoLoverModal>
```

**关键 UI 元素：**

- 道侣头像/形象
- 好感度进度条（带动画）
- 双修按钮（主操作）
- 礼物按钮
- 对话按钮
- 解除关系按钮（危险操作）

### 4.2 游戏主界面集成

**ActionBar 集成：**

- 新增"道侣"按钮，打开道侣面板

**GameHeader 集成：**

- 顶部显示当前道侣头像（如果已结为道侣）
- 显示双修状态（正在进行双修）

**打坐界面集成：**

- 打坐时显示"双修"选项
- 双修时显示双方修为增长

---

## 五、奖励与平衡设计

### 5.1 奖励系统

| 好感度阶段    | 双修加成 | 特殊奖励             |
| ------------- | -------- | -------------------- |
| 0-30 (相识)   | +5%      | 无                   |
| 31-60 (好友)  | +10%     | 偶尔赠送灵石         |
| 61-80 (知己)  | +20%     | 赠送丹药/灵草        |
| 81-100 (道侣) | +30%     | 特殊事件触发概率提升 |

### 5.2 平衡性考虑

**限制机制：**

1. 每日双修次数上限（如 5 次）
2. 双修消耗额外时间/灵石
3. 道侣槽位限制（境界越高槽位越多）
4. 解除关系有冷却时间和代价

**稀有道侣设计：**

- 稀有道侣提供更高的基础加成
- 获得稀有道侣需要更高境界或特殊条件

---

## 六、开发计划

### 6.1 开发阶段

**阶段一：数据结构与常量配置**

- 在 types.ts 中添加道侣相关接口
- 在 constants.ts 中添加道侣模板、礼物列表等常量
- 更新 PlayerStats 接口

**阶段二：核心服务层**

- 创建 daoLoverService.ts
  - 生成随机道侣
  - 计算双修加成
  - 处理互动逻辑
  - 处理好感度变化

**阶段三：UI 组件开发**

- 创建 DaoLoverModal.tsx
- 创建子组件（列表、详情、双修等）
- 在 App.tsx 中集成道侣系统

**阶段四：与现有系统联动**

- 历练系统增加遇到道侣的事件
- 打坐系统增加双修选项
- AI 服务增加道侣内容生成

**阶段五：测试与优化**

- 功能测试
- 平衡性调整
- UI 优化

### 6.2 技术栈

- React + TypeScript
- Tailwind CSS（样式）
- AI 服务（内容生成）

### 6.3 文件清单

| 文件路径                         | 说明             | 状态 |
| -------------------------------- | ---------------- | ---- |
| `types.ts`                       | 添加道侣相关接口 | 新增 |
| `constants/daoLoverConstants.ts` | 道侣常量配置     | 新增 |
| `services/daoLoverService.ts`    | 道侣服务层       | 新增 |
| `components/DaoLoverModal.tsx`   | 道侣管理界面     | 新增 |
| `utils/daoLoverUtils.ts`         | 道侣工具函数     | 新增 |
| `App.tsx`                        | 集成道侣系统     | 修改 |

---

## 七、后续扩展方向

### 7.1 潜在扩展

1. **联机道侣系统**
   - 与真实玩家结为道侣
   - 共同完成任务、副本

2. **道侣技能系统**
   - 道侣学习技能，在战斗中辅助
   - 道侣合击技

3. **道侣剧情系统**
   - 每个道侣有完整剧情线
   - 分支结局

4. **道侣传承**
   - 道侣离世后的传承系统
   - 后代培养

5. **道侣婚礼系统**
   - 举办婚礼庆典
   - 宗门好友祝福

---

## 八、风险评估

### 8.1 技术风险

| 风险                  | 影响 | 概率 | 应对措施               |
| --------------------- | ---- | ---- | ---------------------- |
| AI 生成内容质量不稳定 | 中   | 中   | 预置模板 + AI 混合生成 |
| 平衡性问题            | 高   | 高   | 充分测试，可配置参数   |
| UI 组件复杂度         | 低   | 低   | 复用现有组件设计       |

### 8.2 设计风险

| 风险           | 影响 | 概率 | 应对措施               |
| -------------- | ---- | ---- | ---------------------- |
| 与现有玩法冲突 | 低   | 低   | 独立模块设计，可选玩法 |
| 玩家接受度     | 中   | 中   | 充分测试，收集反馈     |

---

## 九、验收标准

### 9.1 功能验收

- [ ] 玩家可以结识道侣
- [ ] 好感度系统正常工作
- [ ] 双修系统提供正确加成
- [ ] 礼物系统正常工作
- [ ] 道侣事件正常触发
- [ ] 可以解除道侣关系
- [ ] 存档正常保存道侣数据

### 9.2 性能验收

- [ ] 道侣列表加载流畅
- [ ] AI 生成内容响应时间 < 2s
- [ ] 存档大小合理增长

### 9.3 UI/UX 验收

- [ ] 界面美观、符合游戏风格
- [ ] 操作流程清晰
- [ ] 移动端适配良好

---

## 十、参考资料

### 10.1 现有参考代码

- `PetModal.tsx` - 灵宠管理界面
- `SectModal.tsx` - 宗门管理界面
- `aiService.ts` - AI 内容生成服务
- `randomService.ts` - 随机数生成服务

### 10.2 修仙文化参考

- 《诛仙》- 碧瑶、张小凡
- 《仙剑奇侠传》- 赵灵儿、李逍遥
- 《凡人修仙传》- 南宫婉、韩立

---

**文档版本：** v1.0
**创建日期：** 2025-12-24
**文档状态：** 待审核
